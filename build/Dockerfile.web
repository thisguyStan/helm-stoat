# Dockerfile for building Stoat web client
# Source: https://github.com/stoatchat/for-web
# No official container image is published, so we build our own

FROM node:24-alpine AS builder

# Install mise for dependency management
RUN apk add --no-cache bash curl git
RUN curl https://mise.run | sh
ENV PATH="/root/.local/bin:${PATH}"

WORKDIR /app

# Clone the repository at specific version
ARG STOAT_VERSION=stoat-for-web-v0.1.0
RUN git clone --recursive --branch ${STOAT_VERSION} --depth 1 \
    https://github.com/stoatchat/for-web .

# Set build-time environment variables for Vite
# These will be baked into the JavaScript bundle
ARG VITE_API_URL=https://stoat.example.com/api
ARG VITE_WS_URL=wss://stoat.example.com/ws
ARG VITE_MEDIA_URL=https://stoat.example.com/autumn
ARG VITE_PROXY_URL=https://stoat.example.com/january

# Create .env file for build
RUN cd packages/client && \
    echo "VITE_API_URL=${VITE_API_URL}" > .env && \
    echo "VITE_WS_URL=${VITE_WS_URL}" >> .env && \
    echo "VITE_MEDIA_URL=${VITE_MEDIA_URL}" >> .env && \
    echo "VITE_PROXY_URL=${VITE_PROXY_URL}" >> .env

# Install dependencies and build
RUN mise install:frozen && \
    mise build:deps && \
    mise build:prod

# Production stage - serve static files with nginx
FROM nginx:1.27.3-alpine

# Copy built files
COPY --from=builder /app/packages/client/dist /usr/share/nginx/html

# Add nginx configuration for SPA routing
RUN echo 'server { \
    listen 80; \
    root /usr/share/nginx/html; \
    index index.html; \
    location / { \
        try_files $uri $uri/ /index.html; \
    } \
}' > /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
