{{- $fullName := include "stoatchat.fullname" . -}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $fullName }}-config
  namespace: {{ .Values.global.namespace }}
  annotations:
    "helm.sh/resource-policy": keep
type: Opaque
stringData:
  Revolt.toml: |
    production = {{ .Values.global.config.production }}

    [database]
    {{- if .Values.global.subcharts.mongodb.connection_url }}
    mongodb = {{ .Values.global.subcharts.mongodb.connection_url | quote }}
    {{- else if .Values.mongodb.auth.enabled }}
    mongodb = {{ printf "mongodb://root:%s@%s-mongodb/revolt?authSource=admin" (include "stoatchat.deriveSecret" (dict "root" . "id" "mongodb" "length" 32)) $fullName | quote }}
    {{- else }}
    mongodb = {{ printf "mongodb://%s-mongodb" $fullName | quote }}
    {{- end }}
    {{- if .Values.global.subcharts.redis.connection_url }}
    redis = {{ .Values.global.subcharts.redis.connection_url | quote }}
    {{- else if .Values.redis.auth.enabled }}
    redis = {{ printf "redis://:%s@%s-redis-master" (include "stoatchat.deriveSecret" (dict "root" . "id" "redis" "length" 32)) $fullName | quote }}
    {{- else }}
    redis = {{ printf "redis://%s-redis-master" $fullName | quote }}
    {{- end }}

    [rabbit]
    host = {{ .Values.global.subcharts.rabbitmq.host | default (printf "%s-rabbitmq" $fullName) | quote }}
    port = {{ .Values.global.subcharts.rabbitmq.port }}
    username = {{ .Values.rabbitmq.auth.username | quote }}
    password = {{ include "stoatchat.secretValue" (dict "root" . "key" "rabbitmq.password" "default" (include "stoatchat.deriveSecret" (dict "root" . "id" "rabbitmq" "length" 32))) | quote }}

    [hosts]
    app = "https://{{ .Values.global.domain }}"
    api = "https://{{ .Values.global.domain }}/api"
    events = "wss://{{ .Values.global.domain }}/ws"
    autumn = "https://{{ .Values.global.domain }}/autumn"
    january = "https://{{ .Values.global.domain }}/january"

    # Public urls for livekit nodes
    # each entry here should have a corresponding entry under `api.livekit.nodes`
    [hosts.livekit]
    {{- range $v := .Values.global.livekit }}
    {{ $v.name }} = "wss://{{ $v.subdomain }}.{{ $.Values.global.domain }}"
    {{- end }}

    [api]

    [api.registration]
    invite_only = {{ .Values.global.config.registration.invite_only }}

    [api.smtp]
    host = {{ .Values.global.config.smtp.host | quote }}
    username = {{ include "stoatchat.secretValue" (dict "root" . "key" "smtp.username" "default" .Values.global.config.smtp.username) | quote }}
    password = {{ include "stoatchat.secretValue" (dict "root" . "key" "smtp.password" "default" .Values.global.config.smtp.password) | quote }}
    from_address = {{ .Values.global.config.smtp.from_address | quote }}
    {{- with .Values.global.config.smtp.port }}
    port = {{ . }}
    {{- end }}
    {{- if hasKey .Values.global.config.smtp "use_tls" }}
    use_tls = {{ .Values.global.config.smtp.use_tls }}
    {{- end }}
    {{- with .Values.global.config.smtp.reply_to }}
    reply_to = {{ . | quote }}
    {{- end }}

    [api.security]
    authifier_shield_key = {{ include "stoatchat.secretValue" (dict "root" . "key" "security.authifier_shield_key" "default" .Values.global.config.security.authifier_shield_key) | quote }}
    trust_cloudflare = {{ .Values.global.config.security.trust_cloudflare }}
    tenor_key = {{ include "stoatchat.secretValue" (dict "root" . "key" "security.tenor_key" "default" .Values.global.config.security.tenor_key) | quote }}

    [api.security.captcha]
    hcaptcha_key = {{ include "stoatchat.secretValue" (dict "root" . "key" "security.captcha.hcaptcha_key" "default" .Values.global.config.security.captcha.hcaptcha_key) | quote }}
    hcaptcha_sitekey = {{ include "stoatchat.secretValue" (dict "root" . "key" "security.captcha.hcaptcha_sitekey" "default" .Values.global.config.security.captcha.hcaptcha_sitekey) | quote }}

    [api.livekit]
    call_ring_duration = {{ .Values.global.config.livekit.call_ring_duration }}
    
    # Config for livekit nodes
    # Make sure to change the secret when deploying
    # The key and secret should match the values livekit is using

    {{- range $v := .Values.global.livekit }}

    [api.livekit.nodes.{{ $v.name }}]
    url = "http://{{ $fullName }}-livekit-{{ $v.name }}:7880"
    lat = {{ $v.lat | default 0.0 }}
    lon = {{ $v.lon | default 0.0 }}
    key = "{{ $v.name }}"
    secret = {{ ($v.secret | default (include "stoatchat.deriveSecret" (dict "root" $ "id" (printf "livekit-%s" $v.name) "length" 32))) | quote }}

    {{- end }}

    [pushd.vapid]
    private_key = {{ include "stoatchat.vapidPrivateKey" . | quote }}
    public_key = {{ include "stoatchat.vapidPublicKey" . | quote }}

    [pushd.fcm]
    {{- with .Values.global.config.pushd.fcm }}
    key_type = {{ include "stoatchat.secretValue" (dict "root" $ "key" "pushd.fcm.key_type" "default" .key_type) | quote }}
    project_id = {{ include "stoatchat.secretValue" (dict "root" $ "key" "pushd.fcm.project_id" "default" .project_id) | quote }}
    private_key_id = {{ include "stoatchat.secretValue" (dict "root" $ "key" "pushd.fcm.private_key_id" "default" .private_key_id) | quote }}
    private_key = {{ include "stoatchat.secretValue" (dict "root" $ "key" "pushd.fcm.private_key" "default" .private_key) | quote }}
    client_email = {{ include "stoatchat.secretValue" (dict "root" $ "key" "pushd.fcm.client_email" "default" .client_email) | quote }}
    client_id = {{ include "stoatchat.secretValue" (dict "root" $ "key" "pushd.fcm.client_id" "default" .client_id) | quote }}
    auth_uri = {{ include "stoatchat.secretValue" (dict "root" $ "key" "pushd.fcm.auth_uri" "default" .auth_uri) | quote }}
    token_uri = {{ include "stoatchat.secretValue" (dict "root" $ "key" "pushd.fcm.token_uri" "default" .token_uri) | quote }}
    auth_provider_x509_cert_url = {{ include "stoatchat.secretValue" (dict "root" $ "key" "pushd.fcm.auth_provider_x509_cert_url" "default" .auth_provider_x509_cert_url) | quote }}
    client_x509_cert_url = {{ include "stoatchat.secretValue" (dict "root" $ "key" "pushd.fcm.client_x509_cert_url" "default" .client_x509_cert_url) | quote }}
    {{- end }}

    [pushd.apn]
    {{- with .Values.global.config.pushd.apn }}
    sandbox = {{ .sandbox }}
    pkcs8 = {{ include "stoatchat.secretValue" (dict "root" $ "key" "pushd.apn.pkcs8" "default" .pkcs8) | quote }}
    key_id = {{ include "stoatchat.secretValue" (dict "root" $ "key" "pushd.apn.key_id" "default" .key_id) | quote }}
    team_id = {{ include "stoatchat.secretValue" (dict "root" $ "key" "pushd.apn.team_id" "default" .team_id) | quote }}
    {{- end }}

    [files]
    encryption_key = {{ include "stoatchat.fileEncryptionKey" . | quote }}
    webp_quality = {{ .Values.global.config.files.webp_quality }}
    blocked_mime_types = {{ .Values.global.config.files.blocked_mime_types | toJson }}
    clamd_host = {{ .Values.global.config.files.clamd_host | quote }}

    [files.s3]
    # S3 protocol endpoint
    endpoint = {{ .Values.global.subcharts.minio.connection_url | default (printf "http://%s-minio:9000" $fullName) | quote }}
    # Whether to use path-style buckets
    # Generally true, except for MinIO
    path_style_buckets = false
    # S3 region name
    region = "minio"
    # S3 protocol key ID
    access_key_id = {{ include "stoatchat.secretValue" (dict "root" . "key" "minio.access_key_id" "default" (.Values.global.subcharts.minio.access_key_id | default (include "stoatchat.deriveSecret" (dict "root" . "id" "minio-user" "length" 12)))) | quote }}
    # S3 protocol access key
    secret_access_key = {{ include "stoatchat.secretValue" (dict "root" . "key" "minio.secret_access_key" "default" (.Values.global.subcharts.minio.secret_access_key | default (include "stoatchat.deriveSecret" (dict "root" . "id" "minio-pass" "length" 32)))) | quote }}
    default_bucket = {{ .Values.global.config.files.s3.default_bucket | default "revolt-upload" | quote }}

    [features]
    webhooks_enabled = {{ .Values.global.config.features.webhooks_enabled }}
    mass_mentions_send_notifications = {{ .Values.global.config.features.mass_mentions_send_notifications }}
    mass_mentions_enabled = {{ .Values.global.config.features.mass_mentions_enabled }}

    [features.limits]

    [features.limits.global]
    {{- with .Values.global.config.limits.global }}
    group_size = {{ .group_size }}
    message_embeds = {{ .message_embeds }}
    message_replies = {{ .message_replies }}
    message_reactions = {{ .message_reactions }}
    server_emoji = {{ .server_emoji }}
    server_roles = {{ .server_roles }}
    server_channels = {{ .server_channels }}
    new_user_hours = {{ .new_user_hours }}
    body_limit_size = {{ printf "%.0f" (float64 .body_limit_size) }}
    {{- end }}

    [features.limits.new_user]
    {{- with .Values.global.config.limits.new_user }}
    outgoing_friend_requests = {{ .outgoing_friend_requests }}
    bots = {{ .bots }}
    message_length = {{ .message_length }}
    message_attachments = {{ .message_attachments }}
    servers = {{ .servers }}
    voice_quality = {{ .voice_quality }}
    video = {{ .video }}
    video_resolution = {{ .video_resolution | toJson }}
    video_aspect_ratio = {{ .video_aspect_ratio | toJson }}
    {{- end }}

    [features.limits.new_user.file_upload_size_limit]
    {{- with .Values.global.config.limits.new_user.file_upload_size_limit }}
    attachments = {{ printf "%.0f" (float64 .attachments) }}
    avatars = {{ printf "%.0f" (float64 .avatars) }}
    backgrounds = {{ printf "%.0f" (float64 .backgrounds) }}
    icons = {{ printf "%.0f" (float64 .icons) }}
    banners = {{ printf "%.0f" (float64 .banners) }}
    emojis = {{ printf "%.0f" (float64 .emojis) }}
    {{- end }}

    [features.limits.default]
    {{- with .Values.global.config.limits.default }}
    outgoing_friend_requests = {{ .outgoing_friend_requests }}
    bots = {{ .bots }}
    message_length = {{ .message_length }}
    message_attachments = {{ .message_attachments }}
    servers = {{ .servers }}
    voice_quality = {{ .voice_quality }}
    video = {{ .video }}
    video_resolution = {{ .video_resolution | toJson }}
    video_aspect_ratio = {{ .video_aspect_ratio | toJson }}
    {{- end }}

    [features.limits.default.file_upload_size_limit]
    {{- with .Values.global.config.limits.default.file_upload_size_limit }}
    attachments = {{ printf "%.0f" (float64 .attachments) }}
    avatars = {{ printf "%.0f" (float64 .avatars) }}
    backgrounds = {{ printf "%.0f" (float64 .backgrounds) }}
    icons = {{ printf "%.0f" (float64 .icons) }}
    banners = {{ printf "%.0f" (float64 .banners) }}
    emojis = {{ printf "%.0f" (float64 .emojis) }}
    {{- end }}

    [sentry]
    {{- with .Values.global.config.sentry }}
    api = {{ .api | quote }}
    events = {{ .events | quote }}
    voice_ingress = {{ .voice_ingress | quote }}
    files = {{ .files | quote }}
    proxy = {{ .proxy | quote }}
    pushd = {{ .pushd | quote }}
    crond = {{ .crond | quote }}
    gifbox = {{ .gifbox | quote }}
    {{- end }}
